# 区块链之进阶(五):从技术实现理解区块链

---

### 传统分布式一致性算法和区块链共识过程的异同点
相同点：
* Append only
* 强调序列化
* 少数服从多数原则
* 分离覆盖的问题：即长链覆盖短链区块，多节点覆盖少数节点日志

不同点：
* 传统分布式一致性算法大多不考虑拜占庭容错，即假设所有节点只发生宕机、网络故障等非人为问题，并不考虑恶意节点篡改数据的问题
* 传统分布式一致性算法是面向日志(数据库)的，即更通用的情况；而区块链共识模型面向交易的，所以严格来说，传统分布式一致性算法应该处于区块链共识模型的下一层。




## 常见区块链共识模型介绍
### 摘要
本白皮书介绍一种股权证明机制的新实现方式，该方式可以对交易进行秒级验证，并且能够在更短的时间内提供比现有任何股权证明系统都更好的安全性。在比特币网络产生一个区块的时间过后，一个授权股权证明系统(DPOS)能使你的交易得到20%股东的核实，而在比特币网络声明交易已不可逆(6个区块，约1小时)的时间过后，在DPOS机制下，通过其代表，你的交易已经得到100%股东的核实。

### 背景
分布式交易总帐需要在尽可能短的时间内做到安全、明确及不可逆，便于提供一个最坚实且去中心化的系统。在实践中，该流程分为两个方面：选择一个独特的节点来产生一个区块，并使得交易总账不可逆。

### 工作量证明机制(Proof of Work, POW)
第一个成功解决该问题的尝试是比特币系统(Bitcoin)，比特币系统使用工作量证明机制使更长总账的产生具有计算性难度。工作量证明机制就好比是乐透，平均每10分钟有一个节点找到一个区块。如果两个区块在同一时间找到区块，那么网络将根据后续节点的决定来确定以哪个区块构建总账。从统计角度讲，一笔交易在6个区块(约1个小时)后被认为是明确确认且不可逆的。然而，核心开发者认为，需要120个区块(约一天)，才能充分保护网络不受来自潜在更长的已将新产生的币划掉的攻击区块链的威胁。
尽管出现更长的区块链会变得不太可能，但任何拥有巨大经济资源的人都仍有可能制造一个更长的区块链或者具备足够的哈希算力来冻结用户的账户。

### 股权证明机制(Proof of Stake, POS)
股权证明机制已有很多不同变种，但基本概念是产生区块的难度应该与你在网络里所占的股权(所有权占比)成比例。到目前为止，已有两个系统开始运行:点点币(Peercoin)和未来币(NXT)。点点币使用一种混合模式，用你的股权调整你的挖矿难度。未来币使用一个确定性算法以随机选择一个股东来产生下一个区块。未来币算法基于你的账户余额来调整你被选中的可能性。
未来币和点点币都分别解决了谁来生产下一个区块的问题，但他们没有找到在适当的时间内使区块链具备不可逆的安全性的方法。根据我们能找到的信息，做到这点，点点币需要至少6个区块(约1小时)，未来币需要10个区块。我们找不到在10个区块后未来币能提供什么级别安全性的根据。

### 瑞波共识机制(Ripple Consensus)
瑞波共识算法，使一组节点能够基于特殊节点列表达成共识。初始特殊节点列表就像一个俱乐部，要接纳一个新成员，必须由51%的该俱乐部会员投票通过。共识遵循这核心成员的51%权利，外部人员则没有影响力。由于该俱乐部由"中心化"开始，它将一直是“中心化”的，如果它开始腐化，股东们什么也做不了。与比特币及点点币一样，瑞波系统将股东们与其投票权隔开，并因此比其他系统更中心化。

### 授权股权证明机制(DPOS)
当使用去中心化自治公司(Decentrailized Autonomous Company, DAC)这一说法时，去中心化表示每个股东按其持股比例拥有影响力，51%股东投票的结果将是不可逆且有约束力的。其挑战是通过及时而高效的方法达到51%批准。
为达到这个目标，每个股东可以将其投票权授予一名代表，获票数最多的前100位代表按既定时间表轮流产生区块。每名代表分配到一个时间段来生产区块。所有的代表将收到等于等同于一个平均水平的区块所含交易费的10%作为报酬。如果一个平均水平的区块含有100股作为交易费，一名代表将获得1股作为报酬。
网络延迟有可能使某些代表没能及时广播他们的区块，而这将导致区块链分叉。然而，这不太可能发生，因为制造区块的代表可以与制作前后区块的代表建立直接连接。建立这种与你之后的代表(也许也包括其后的那名代表)的直接连接是为了确保你能得到报酬。

1. 成为一名代表
成为一名代表，你必须在网络上注册你的公钥，然后分配到一个32为的特有标识符，然后该标识符会被每笔交易数据的“头部”引用。

2. 授权你的选票
每个钱包有一个参数设置窗口，在该窗口里用户可以选择一个或更多的代表，并将其分级。一经设定，用户所做的每笔交易将把选票从“输入代表”转移至“输出代表”。一般情况下，用户不会创建特别以投票为目的的交易，因为那将耗费他们一笔交易费。但在紧急情况下，某些用户可能觉得通过支付费用这一更积极的方式来改变他们的投票是值得的。

3. 保持代表诚实
每个钱包将显示一个状态指示器，让用户知道他们的代表表现如何。如果他们错过了太多的区块，那么系统将会推荐用户去换一个新的代表。如果任何代表被发现签发了一个无效的区块，那么所有标准钱包将在每个钱包进行更多交易前要求选出一个新代表。

4. 解决区块链分叉
和工作量证明系统及其他股权证明系统一样，最佳区块链是最长的有效区块链。任何时候，一名代表错过签发一个区块的机会，该区块链将比潜在竞争对手短。只要在你的交易被写入区块后的100个区块中的51%被生产出来了，那么你就可以安全地认为你在主区块链上。

5. 100名代表是去中心化的吗？
我们将自由市场看座去中心化的基本形式，并将对进入自由市场设置障碍看做是所有中心化的基础。像任何事物一样，中心化有程度之分，所以我们把授权股权证明机制同其他方案的中心化程度进行对比。

* 比特币
比特币系统目前正以授权工作量证明(DPOW)为基础运行，因此有大约10名代表控制了绝大多数的哈希算力。在那些为其竞争而能使用规模经济进行无收益挖矿的人手中，哈希算力本身就是中心化的。最后，工作量证明机制为进入市场设置障碍，使得“在职”的区块制造者无法轻易被取代。与比特币系统相比，DPOS在区块生成方法至少去中心化了10倍，并且也许在市场竞争方面去中心化了无数倍。
尽管在哈希算力方面有一定量的去中心化，当想到掌控比特币系统的股东(比特币持有者)所持股份的占比，我们认为比特币系统是最中心化的。如果你考虑使用比特币体系的用户数，其中参与挖矿的人很有可能少于百分之一。

* 点点币
点点币是一个混合系统，所以它由于工作量证明机制而是部分中心化的。和比特币系统一样，它有矿池。与比特币相比，点点币无疑是更去中心化的，然而，因为股权证明机制矿池需要用户保持他们的电脑在线且钱包解锁，只有一小部分的股东参与了任何形式的挖矿。

* 未来币
未来币使用透明锻造，以确定的选出下一个制造节点。可以将其类比为，使用授权股权证明机制但你只能将你的投票权授予你自己，而你获得锻造区块机会的频率直接取决于你账户余额。在这个意义上来说，未来币比点点币和比特币更为去中心化。但由于对安全风险的顾虑以及事实上大多数常规用户不会整天开启他们的电脑来借此获得锻造机会方面的优势，它仍然遭受着少的可怜的挖矿参与度。
从这个角度来说，我们可以断定未来币网络是由一小部分股东来保障网络安全的。事实上，如果你不上线投票，那么你将失去你的选票。为了解决这个问题，一些未来币用户用他们的股权建立股权池，并信任第三方来为他们挖矿。这是以一种形式的授权股权证明来提高股东参与度，但这也使他们的账户余额在他们参加这些矿池时承受风险。

### 攻击
一般而言，网络必须抵御两种类型的攻击：拒绝服务攻击和双重支付攻击。一个攻击者通过不把一些或全部的交易加入总账来进行拒绝服务攻击，这种攻击可以由任何拥有51%网络(无论比特币、未来币或其他)的人进行。而利用在网络正试图达成共识时的短期优势，可以进行双重支付攻击。为抵御这些攻击，网络必须使51%的股东尽快达成协议。

1. 防止排除交易
拥有全部经股东投票选出的100名代表，并且按要求轮流生产区块，意味着任何一笔由至少1%的股东批准的交易能够在30分钟内加入总账。这意味着没有代表可以通过将投票支持其他代表的交易排除在外来获取利益。

2. 将一些代表的权力中心化
与其所被授权的投票权无关，这前100人所获得的权力权重是相同的，每名代表都有一份相等的投票权。因此，无法通过获得超1%的选票而将权力集中到一个单一代表手上。
个人或者组织控制区块链的多名代表是有可能的。但是这个过程将需要欺骗很大比例的股东数去支持"傀儡"。即使可以建立这51%傀儡，他们扰乱网络的能力仍将是有限的，能够被快速识别快速纠正的。没有工作量证明机制设置的进入障碍，占据多数的诚实用户会把攻击鉴别出来，然后将代码分叉并无视攻击者生产的区块，这种攻击可以扰乱网络，但不会是致命的。

3. 针对代表的分布式拒绝服务攻击(DDOS)
因为只有100名代表，可以想象一个攻击者对每名轮到生产区块的代表依次进行拒绝服务攻击。幸运的是，由于事实上每名代表的标识是公钥而非IP地址，这种特定攻击的威胁很容易被减轻。这将使确定DDOS攻击目标更为困难。而代表直接的潜在直接连接，将使妨碍他们生产区块变得更为困难。

### 基于交易的股权证明机制(TaPOS)
代表制是一个短时间内达成坚固共识的高效方式，而TaPOS为股东们提供了一个长效机制来直接批准他们的代表的行为。平均而言，51%的股东在6个月内会直接确认每个区块，而取决于活跃流动的股份所占的比例，差不多10%的股东可以在几天内确认区块。这种直接确认保障了网络的长期安全，并使所有的攻击尝试变得极度清晰易见。

### 结论
DPOS流程和TaPOS结合所产生的网络，其网络共识的可证明性将至少3倍于比特币、点点币以及未来币网络。DPOS能够更快达成共识，同时消除随机小股东带来的小规模干扰的可能性。经济激励确保了代表们致力于证明他们有良好的行为，并可能采用类似于瑞波系统的共识算法(来实现这种证明)。DPOS，事实上，是一种通过无网络分叉之虞的去中心化方式来产生瑞波特殊节点列表的方法。



