# 区块链之进阶(三)
---

### 公有链、私有链、侧链
公有链的典型代表是比特币区块链，任何人都可以通过交易或者挖矿读取和写入数据。私有链或联盟链的典型案例是Ripple和R3 CEV，前者目前为属于联盟成员的银行类金融机构提供跨境支付服务，希望取代环球同业银行金融电讯协会(SWIFT)的跨境转账平台，打造全球统一的网络金融传输协议；后者旨在推动制定适合金融机构使用的区块链技术标准。

侧链(Sidechains)是用于确认来自与其它区块链的数据的区块链，通过双向挂钩(Two Wap Peg)机制使比特币，Ripple币等多种资产在不同区块链上以一定的汇率实现转移。
<div align = "center">
<img src="https://raw.githubusercontent.com/lengender/MarkdownPhotos/master/%E4%BE%A7%E9%93%BE.png" width="500" height="400" alt="文件事件处理器"/>
    </div>
    
侧链进一步扩展了区块链技术的应用范围和创新空间，是区块链支持包括股票、债券、金融衍生品等在内的多种资产类型，以及小微支付、智能合约、安全处理机制、真实世界财产注册等；侧链还可以增强区块链的隐私保护。

所谓“多种资产在不同的区块链上转移”其实并不会实际发生。以比特币为例，侧链的运作机制是，将比特币暂时锁定在比特币区块链上，同时将辅助区块链上的等值数字货币解锁；当辅助区块链上的数字货币被锁定时，原先的比特币就被解锁。

### 比特币区块链任何运作？
比特币网络从2009年1月开始至今，在没有专人维护的情况下已经平稳运行到现在，期间没有出现过一次宕机。下图以Bob接收来自Alice的比特币的场景，详细描述了比特币区块链的工作方式，一并解释了涉及到钱包和地址(Wallets and Addresses)、私钥和公钥(Private Key and Public Key)、加密哈希(Cryptographic Hashes)、随机数(Nonces)等概念。
![此处输入图片的描述][1]

钱包和地址：
1. Bob和Alice的电脑都有比特币钱包。
2. 钱包是一种文件，可以让用户访问多个比特币地址
3. 一个地址是由一串字母和数字组成的字符串
4. 每一个地址都有自己的比特币余额

新建一个地址：
5. Bob创建一个新的比特币地址，用于接收Alice的付款

私钥和公钥：
6. 当Bob创建一个新地址时，他真正在做的是生成一个密钥对，由一个私钥和一个公钥组成。如果你使用私钥(只有你知道)对一个消息进行签名，它可以被对应的公钥(所有人都知道)所验证。Bob的新地址代表一个唯一的公钥，对应的私钥则保存在他的钱包里面。公钥允许所有人来验证被私钥签名的消息的有效性。
7. 可以将地址看做银行账号，但工作方式稍有不同。比特币用户可以任意创建多个地址，并且被鼓励为每一个新的交易单独创建新地址，以增强隐私性。只要没有人知道哪些地址是Alice的，她的匿名就受到保护。

提交一个支付：
8. Alice告诉她的比特币客户端，她要向Bob的收款地址转账
9. Alice的钱包里有她的每一个比特币地址的私钥。比特币客户端用Alice此次使用的付款地址的私钥，对她的这一交易申请进行签名
10. 此时，网络上的任何人都可以通过使用公钥来验证，这个交易申请实际来自一个合法的账户所有者

验证交易：
11. Gary, Garth和Glenn都是比特币矿工
12. 他们的电脑将过去约10分钟内的交易打包成一个新的交易区块
13. 矿工的电脑被设置用于计算加密哈希(Cryptographic Hash)函数。
14. 加密哈希函数将一个数据集转换成特定长度的包含字母和数字的字符串，称为哈希值。源数据的细微改变会彻底改变哈希值的结果。并且基本不可能预测初始的数据集会产生的特定哈希值
15. 为相同的数据创建不同的哈希值，比特币使用随机数来实现。随机数是在进行哈希计算之前，在数据中添加的随机数字。改变这个随机数会产生极不相同的哈希值
16. 每一个新的哈希值包含关于此前所有比特币交易的信息
17. 矿工的电脑基于前一个区块的哈希值、新交易区块和随机数，来计算新的哈希值
18. 创建哈希在计算上微不足道，但比特币系统要求新的哈希值拥有特定格式——必须以特定数量的0作为开始
19. 矿工无法预测哪个随机数会产生以要求数量的0作为哈希值，所以他们被迫用不同的随机数创建很多哈希，直到获得有效的那一个
20. 每一个区块都包含一个名为coinbase的初始交易，这是给胜出矿工的50比特币的支付——在这个例子中是矿工Gary，Gray的钱包生成了一个新地址，里面的余额是新挖到的比特币数量。

注意：只有比特币发行的阶段一，每一个区块的coinbase支付给胜出矿工的新币是50个。从2009年1月3日创世区块链诞生开始，新比特币的发行大约每4年减半，2012年11月28日，阶段二开始，每一个区块包含的新币减为25个。2017年7月11日，挖矿奖励再次减半；直到第33次减半时，每一个区块从产生0.0021个新币直接减到0个，比特币的总量固定在将近2100万个。

交易验证：
21. 随着时间流逝，Alice向Bob的转账被埋在了其他更近期的交易下面。任何人想要修改历史交易的细节，就必须重做一遍Gray的工作，然后再重做所有下一级矿工的工作，因为所有的改变都需要一个完全不同的胜出随机数。这样的操作几乎是不可能成功。


### 双重支付如何解决？
以比特币为代表的数字货币，关键的创新是通过时间戳(Timestamp)和工作量证明(Proof of Work)机制解决双重支付(Double Spending)和拜占庭将军问题，即保证同一笔比特币不会同时出现在两个地址，并且在信道可靠的基础上，所有节点都可以让其他节点接收到自己的真是意图，并最终一致行动。

在Bob接收来自Alice的比特币场景中，一方面，这笔付款被广播给系统中的所有节点，任何人都可以使用Bob的公钥来验证这个交易的合法性。如果Alice试图双重支付，就必须先删除这个交易记录，否则新交易无法通过验证。

中本聪在论文中写到：

    时间戳服务器为一个区块的数据的哈希计算结果加上时间戳，并大范围发布这一哈希计算结果，好比在报纸或新闻网上发表。显然，时间戳证实这些数据一定在这一特定时间存在，只有这样的才能得到哈希计算结果。
    
* 另一方面，工作量证明机制使得生成下一个区块的节点和矿工几乎无法被预测到，所以删除交易记录几乎不可能。系统中的节点将过去约10分钟内的比特币交易打包，而只有获得有效哈希值的矿工才能生成新区块，并获得挖矿奖励；矿工出了打包比特币交易，还要结合随机数来完成有效哈希值的创建工作，获得以要求的数量的0作为开始的哈希值。

* 工作量证明本质上是一CPU一票。
* 如果两个节点同时广播不同版本的新区块，那么一些节点会先收到其中一个的广播。在这种情况下，节点在先收到的区块基础上工作，并保留另外一个分支，以防后者变成较长的链。这个僵局要等发现下一个工作量证明才能被打破，其中一条链将成为较长的链，在另一个分支上工作的节点将切换到较长的链上继续工作。
* 节点永远认为最长的链是正确的链，并将持续在它上面延长。

所以除非永久控制整个系统中超过一半的节点，才能阻止矿工把这个交易添加到新区块中。

最后，考虑到硬件运算速度的增长和节点参与程序的变化，中本聪用移动平均目标来确定工作量证明的难度，使得两个区块生成的时间间隔约为10分钟。


### 区块链技术目前的问题
区块链技术还处于不断完善的阶段，就其第一个应用的比特币来说，有3个主要问题正被其他系统所完善或试图完善

1. 区块容量和交易速度限制
中本聪设计比特币时，为区块设置了1MB的容量限制，使每一个区块只能容纳4096个交易，同时，工作量证明机制使得确认交易并将交易记录到区块链中需要约为10分钟，当运算量达到极限时，运算时间就会放缓。目前，比特币网络还没有成熟到可以将规模扩展至主要信用卡网络的程度。
另外，区块扩容已经成为迫切需求。曾有比特币核心开发者提出从Bitcoin Core切换到硬分叉链Bitcoin XT的方案，区块从1MB扩容至8MB，此后每2年翻倍。这一变动需要1000个连续区块中的750个包含矿工的变更批准。

2. 挖矿浪费巨大资源
由于挖矿工作只为搜索到随机数以获得有效哈希值，并不产生其他价值，比特币网络的算力资源和消耗的电力成本被诟病为资源浪费。其他系统改进这个问题的总思路是，减少其中参与维护工作节点的数量，减轻挖矿竞争的激烈程度。具体有两种方式：一是采用私有链或联盟链，将记账权强制规定给某些节点；二是引入权益证明机制，配合工作量证明来维护可靠数据库。
权益证明是一种对货币所有权的证明，证明人需要提供一定数量的货币的使用权，系统根据每一个节点所占有的货币的比例和占有时间来确定记账权；权益证明的核心是只让在区块链中具有经济效益的人参与系统的维护工作。这就使得挖矿的成本远低于工作量证明机制下的挖矿成本。

3. 缺少图灵完整性
既然区块链可以保证比特币交易记录不被删除，理论上也可以保证任何代码一旦被写入，就不能删除。然而，比特币的脚本语言并不是图灵完备的，既不支持循环语句，意味着比特币只能作为数字货币，不能直接支持智能合约及更复杂的去中心化应用。
区块链技术平台以太坊的脚本就是图灵完备的；用EVM代码来建立应用，理论上可以实现任何可以想象的计算，包含无限循环。以太坊实现了让任何人可以上传和执行任意的应用程序，并且程序的有效执行得到保证。

### 智能合约如何运作？
智能合约是一种直接控制数字资产的电脑程序。下图描述了基于比特币的智能合约的工作方式，通过区块链上写入类似if-then语句的程序，使得当预先编好的条件被触发时，程序自动触发支付以及执行合约中的其他条款。

<div align = "center">
<img src="https://raw.githubusercontent.com/lengender/MarkdownPhotos/master/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6.png" width="600" height="500" alt="智能合约"/>
    </div>

1. 多方之间的定期交付合同被以代码的形式写入区块链。其中的个体是匿名的，但合同记录在公共账本中。
2. 当扳机时间触发时，比如到期、执行价格达到，合约按照编程的条款自动执行。
3. 监管者可以通过这个区块链了解市场上的活动，同时维护个体的隐私。












  [1]: https://raw.githubusercontent.com/lengender/MarkdownPhotos/master/%E6%AF%94%E7%89%B9%E5%B8%81%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F.png